---
title: "02 Data Analysis"
output: html_document
---

### DATAFRAMES USED

|Name|Definition|
|------|----------|
|*cri*| Original replication data at the effect-level in wide format|
|*cri_long*| Raw replication results in long form|
|*cri_cur_long*|Curated results in long form|
|*cri_long_trim*|Trimmed results (5%) in long form|
|*cri_team_orig*|Raw results aggregated by team|
|*cri_team_cur*|Curated results aggregated by team|
|*cri_team_trim*|Trimmed results aggregated by team|

This file uses the cleaned data for the following variables to provide statistical output.

### DEPENDENT VARIABLES

|Metric|Definition|Measure|
|------|----------|---------|
|*Verification* (verif)| The direction of the regression coefficient is the same as the original & either within 0.05 absolute difference or the same significance at p<0.05 threshold|1=verified, 0=not|
|*Exact Replication* (exact)|The ratio of the replication odds ratio to the original is within a 1% margin (i.e., within 0.01 decimal places)|1=exact, 0=not|
|*Replication Error* (deviance_abs)|The absolute deviation of the replicated odd-ratio from the original odds-ratio | continuous measure starting from exact (=0) and increasing in positive values to measure the error |

```{r setup, warning = F, message = F}
rm(list = ls())
library(pacman)

pacman::p_load("dplyr", "readr", "lattice", "tidyr", "readxl", "knitr", "boot", "ragg", "kableExtra", "ggpubr","lme4", "jtools","sjPlot", "sjmisc", "sjlabelled", "rvest", "lavaan", "lavaanPlot", "see", "ggtext", "specr")

```

## Load Data

```{r setup2, warning = F, message = F}
# load data from 01_Data_Prep
load(file = here::here("data","data.Rdata"))


# disable scientific notation
options(scipen = 999)
```


## Statistics and Predictive Models

### Correlations by Group

```{r corr, warning = F, message = F}
cri_team_c<- cri_team_cur %>%
  select(exp, verif_m, exact_m, dev_m, stata, stat_skill, difficult, degree_soc, numinteam, Mistake, Procedural, Mistake_Procedural, Interpretational, Questionable_Skills)

cri_team_orig_c <- cri_team_orig %>%
  select(exp, verif_m, exact_m, dev_m, stata, stat_skill, difficult, degree_soc, numinteam, Mistake, Procedural, Mistake_Procedural, Interpretational, Questionable_Skills)

cri_team_trimmed_c <- cri_team_trimmed %>%
  select(exp, verif_m, exact_m, dev_m, stata, stat_skill, difficult, degree_soc, numinteam, Mistake, Procedural, Mistake_Procedural, Interpretational, Questionable_Skills)

# Curated

cri_team_c_T <- cri_team_c %>%
  subset(exp == 1) %>%
  select(-exp) %>%
  cor(., use = "pairwise.complete") %>%
  round(., 3) %>%
  as.data.frame()

cri_team_c_T[upper.tri(cri_team_c_T)] <- ""

cri_team_c_O <- cri_team_c %>%
  subset(exp == 0) %>%
  select(-exp) %>%
  cor(., use = "pairwise.complete") %>%
  round(., 3) %>%
  as.data.frame()

cri_team_c_O[upper.tri(cri_team_c_O)] <- ""

# Raw Original

cri_team_orig_c_T <- cri_team_orig_c %>%
  subset(exp == 1) %>%
  select(-exp) %>%
  cor(., use = "pairwise.complete") %>%
  round(., 3) %>%
  as.data.frame()

cri_team_orig_c_T[upper.tri(cri_team_orig_c_T)] <- ""

cri_team_orig_c_O <- cri_team_orig_c %>%
  subset(exp == 0) %>%
  select(-exp) %>%
  cor(., use = "pairwise.complete") %>%
  round(., 3) %>%
  as.data.frame()

cri_team_orig_c_O[upper.tri(cri_team_orig_c_O)] <- ""

# Trimmed

cri_team_trimmed_c_T <- cri_team_trimmed_c %>%
  subset(exp == 1) %>%
  select(-exp) %>%
  cor(., use = "pairwise.complete") %>%
  round(., 3) %>%
  as.data.frame()

cri_team_trimmed_c_T[upper.tri(cri_team_trimmed_c_T)] <- ""

cri_team_trimmed_c_O <- cri_team_trimmed_c %>%
  subset(exp == 0) %>%
  select(-exp) %>%
  cor(., use = "pairwise.complete") %>%
  round(., 3) %>%
  as.data.frame()

cri_team_trimmed_c_O[upper.tri(cri_team_trimmed_c_O)] <- ""

write.csv(cri_team_c_T, here::here("results","Tbl9_1.csv"), row.names = F)
write.csv(cri_team_c_O, here::here("results","Tbl9_2.csv"), row.names = F)
write.csv(cri_team_orig_c_T, here::here("results","Tbl9_3.csv"), row.names = F)
write.csv(cri_team_orig_c_O, here::here("results","Tbl9_4.csv"), row.names = F)
write.csv(cri_team_trimmed_c_T, here::here("results","Tbl9_5.csv"), row.names = F)
write.csv(cri_team_trimmed_c_O, here::here("results","Tbl9_6.csv"), row.names = F)
   
```


### Regressions Predicting Reproducibility


```{r regs}
# original - pooled
O_1 <- lm(exact_m ~ stata + stat_skill + difficult + degree_soc + exp, data = cri_team_orig)
O_2 <- lm(verif_m ~ stata + stat_skill + difficult + degree_soc + exp, data = cri_team_orig)
O_3 <- lm(dev_m ~ stata + stat_skill + difficult + degree_soc + exp, data = cri_team_orig)

# original - by group
O_1_aTG <- lm(exact_m ~ stata + stat_skill + difficult, data = subset(cri_team_orig, exp == 1))
O_2_aTG <- lm(verif_m ~ stata + stat_skill + difficult, data = subset(cri_team_orig, exp == 1))
O_3_aTG <- lm(dev_m ~ stata + stat_skill + difficult, data = subset(cri_team_orig, exp == 1))

O_1_OG <- lm(exact_m ~ stata + stat_skill + difficult, data = subset(cri_team_orig, exp == 0))
O_2_OG <- lm(verif_m ~ stata + stat_skill + difficult, data = subset(cri_team_orig, exp == 0))
O_3_OG <- lm(dev_m ~ stata + stat_skill + difficult, data = subset(cri_team_orig, exp == 0))

# curated - pooled
M_1 <- lm(exact_m ~ stata + stat_skill + difficult + degree_soc + exp, data = cri_team_cur)
M_2 <- lm(verif_m ~ stata + stat_skill + difficult + degree_soc + exp, data = cri_team_cur)
M_3 <- lm(dev_m ~ stata + stat_skill + difficult + degree_soc + exp, data = cri_team_cur)

# curated - by group
M_1_aTG <- lm(exact_m ~ stata + stat_skill + difficult, data = subset(cri_team_cur, exp == 1))
M_2_aTG <- lm(verif_m ~ stata + stat_skill + difficult, data = subset(cri_team_cur, exp == 1))
M_3_aTG <- lm(dev_m ~ stata + stat_skill + difficult, data = subset(cri_team_cur, exp == 1))

M_1_OG <- lm(exact_m ~ stata + stat_skill + difficult, data = subset(cri_team_cur, exp == 0))
M_2_OG <- lm(verif_m ~ stata + stat_skill + difficult, data = subset(cri_team_cur, exp == 0))
M_3_OG <- lm(dev_m ~ stata + stat_skill + difficult, data = subset(cri_team_cur, exp == 0))

# trimmed - pooled

T_1 <- lm(exact_m ~ stata + stat_skill + difficult + degree_soc + exp, data = cri_team_trimmed)
T_2 <- lm(verif_m ~ stata + stat_skill + difficult + degree_soc + exp, data = cri_team_trimmed)
T_3 <- lm(dev_m ~ stata + stat_skill + difficult + degree_soc + exp, data = cri_team_trimmed)

# trimmed - by group

T_1_aTG <- lm(exact_m ~ stata + stat_skill + difficult, data = subset(cri_team_trimmed, exp == 1))
T_2_aTG <- lm(verif_m ~ stata + stat_skill + difficult, data = subset(cri_team_trimmed, exp == 1))
T_3_aTG <- lm(dev_m ~ stata + stat_skill + difficult, data = subset(cri_team_trimmed, exp == 1))

T_1_OG <- lm(exact_m ~ stata + stat_skill + difficult, data = subset(cri_team_trimmed, exp == 0))
T_2_OG <- lm(verif_m ~ stata + stat_skill + difficult, data = subset(cri_team_trimmed, exp == 0))
T_3_OG <- lm(dev_m ~ stata + stat_skill + difficult, data = subset(cri_team_trimmed, exp == 0))

orig_results <- mget(ls(pattern = "O_"))
cur_results <- mget(ls(pattern = "M_"))
trim_results <- mget(ls(patter = "T_"))

```

### Results

Saved in Word for paper, hidden here in markdown.
```{r results, include = F}
tab_model(orig_results, show.se = T, show.ci = F, p.style = "stars", p.threshold = c(0.05, 0.01, 0.001), dv.labels = c("Pooled","TG","OG","Pooled","TG","OG","Pooled","TG","OG"), file = here::here("results", "Reg_Table_Orig.doc"))

tab_model(cur_results, show.se = T, show.ci = F, p.style = "stars", p.threshold = c(0.05, 0.01, 0.001), dv.labels = c("Pooled","TG","OG","Pooled","TG","OG","Pooled","TG","OG"), file = here::here("results", "Reg_Table_Cur.doc"))

tab_model(trim_results, show.se = T, show.ci = F, p.style = "stars", p.threshold = c(0.05, 0.01, 0.001), dv.labels = c("Pooled","TG","OG","Pooled","TG","OG","Pooled","TG","OG"), file = here::here("results", "Reg_Table_Trim.doc"))
```

Printed here in workflow

#### Original

```{r results2}
tab_model(orig_results, show.se = F, show.ci = F, p.style = "stars", p.threshold = c(0.05, 0.01, 0.001), dv.labels = c("Exact Pooled","Exact TG","Exact OG","Verif Pooled","Verif TG","Verif OG","Error Pooled","Error TG","Error OG"))
```


#### Curated

```{r results3}
tab_model(cur_results, show.se = F, show.ci = F, p.style = "stars", p.threshold = c(0.05, 0.01, 0.001), dv.labels = c("Exact Pooled","Exact TG","Exact OG","Verif Pooled","Verif TG","Verif OG","Error Pooled","Error TG","Error OG"))
```

#### Trimmed

```{r trim_results}
tab_model(trim_results, show.se = F, show.ci = F, p.style = "stars", p.threshold = c(0.05, 0.01, 0.001), dv.labels = c("Pooled","TG","OG","Pooled","TG","OG","Pooled","TG","OG"))
```

#### Error Source

We investigate the multivariate associations of team-level variables and whether they made mistakes and/or had procedural variations. To do this we subset our team sample first to include only those teams that had at least one instance of the category Mistake or Mistake-Procedural (=1) and all other teams except those with instances of Procedural (=0). If a team has a Mistake and Procedural code they are coded as = 1. Next we do a similar subset where cases are kept with at least one instance of Procedural and Mistake-Procedural (=1) with those having any Mistake dropped.

```{r reg_error}
# set up data
cri_team_mistake <- cri_team_cur %>%
  mutate(Mistake_DV = ifelse(Mistake == 1 | Mistake_Procedural == 1, 1, 0),
         drop = ifelse(Mistake_DV != 1 & Procedural == 1, 0, 1)) %>%
  subset(drop == 1)

cri_team_proc <- cri_team_cur %>%
  mutate(Procedural_DV = ifelse(Procedural == 1 | Mistake_Procedural == 1, 1, 0),
         drop = ifelse(Procedural_DV !=1 & Mistake == 1, 0, 1)) %>%
  subset(drop == 1)

MIS_1 <- lm(Mistake_DV ~ stata + stat_skill + difficult + exp, data = cri_team_mistake)
PRO_1 <- lm(Procedural_DV ~ stata + stat_skill + difficult + exp, data = cri_team_proc)
MIS_2 <- lm(Mistake_DV ~ stata + stat_skill + difficult, data = subset(cri_team_mistake, exp == 1))
PRO_2 <- lm(Procedural_DV ~ stata + stat_skill + difficult, data = subset(cri_team_proc, exp == 1))
MIS_3 <- lm(Mistake_DV ~ stata + stat_skill + difficult, data = subset(cri_team_mistake, exp == 0))
PRO_3 <- lm(Procedural_DV ~ stata + stat_skill + difficult, data = subset(cri_team_proc, exp == 0))
```


```{r results4, warning = F, message = F}
tab_model(MIS_1, MIS_2, MIS_3, PRO_1, PRO_2, PRO_3, show.se = F, show.ci = F, p.style = "stars", p.threshold = c(0.05, 0.01, 0.001))

tab_model(MIS_1, MIS_2, MIS_3, PRO_1, PRO_2, PRO_3, show.se = T, show.ci = F, p.style = "stars", p.threshold = c(0.05, 0.01, 0.001), file = here::here("results", "Reg_Table_Cats.doc"))
```

#### Robustness check as logits

```{r reg_error_logit}
# reviewer asked us to re-run these as logits
MIS_1L <- glm(Mistake_DV ~ stata + stat_skill + difficult + exp, data = cri_team_mistake, family = 'binomial')
PRO_1L <- glm(Procedural_DV ~ stata + stat_skill + difficult + exp, data = cri_team_proc, family = 'binomial')
MIS_2L <- glm(Mistake_DV ~ stata + stat_skill + difficult, data = subset(cri_team_mistake, exp == 1), family = 'binomial')
PRO_2L <- glm(Procedural_DV ~ stata + stat_skill + difficult, data = subset(cri_team_proc, exp == 1), family = 'binomial')
MIS_3L <- glm(Mistake_DV ~ stata + stat_skill + difficult, data = subset(cri_team_mistake, exp == 0), family = 'binomial')
PRO_3L <- glm(Procedural_DV ~ stata + stat_skill + difficult, data = subset(cri_team_proc, exp == 0), family = 'binomial')
```
Note that there are only 5 outcomes of 1 in Procedural for the TG. This seems to cause convergence problems when specifying a binomial function. So this is left out of the regression table. 

```{r logitout}
tab_model(MIS_1L, MIS_2L, MIS_3L, PRO_1L, PRO_3L, show.se = F, show.ci = F, p.style = "stars", p.threshold = c(0.05, 0.01, 0.001))
```

#### Test # of Teams with 0.0 Error

```{r t}
unique(cri_team_orig$u_teamid[cri_team_orig$dev_m == 0])
```

They are all in the TG

```{r tg}
unique(cri_team_orig$u_teamid[cri_team_orig$dev_m == 0 & cri_team_orig$exp == 1])
```


## Save Image

```{r data_figs}
rm(MIS_1, MIS_2, MIS_3, M_1, M_1_OG, M_1_aTG, M_2, M_2_OG, M_2_aTG, M_3, M_3_OG, M_3_aTG, T_1, T_1_OG, T_1_aTG, T_2, T_2_OG, T_2_aTG, T_3, T_3_OG, T_3_aTG, O_1, O_1_OG, O_1_aTG, O_2, O_2_OG, O_2_aTG, O_3, O_3_OG, O_3_aTG, PRO_1, PRO_2, PRO_3, MIS_1L, MIS_2L, MIS_3L, PRO_1L, PRO_2L, PRO_3L)

save.image(file = here::here("data","data_figs.Rdata"))
```


## Colophon

```{r sessioninfo}
sessionInfo()
```



